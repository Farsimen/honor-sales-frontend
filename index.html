<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±ÙˆØ´ Honor</title>
<style>
  body {
    margin: 0; padding: 20px; font-family: Tahoma, sans-serif; background: linear-gradient(135deg, #0a0a23 0%, #181f3a 50%, #1a164e 100%);
    color: white; min-height: 100vh;
  }
  .admin-icon {
    position: fixed; top: 20px; right: 20px; width: 48px; height: 48px; background: rgba(255,255,255,0.16);
    border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 1000;
    font-size: 24px;
  }
  #adminMenu {
    display: none; position: fixed; top: 80px; right: 20px; background: rgba(20,20,40,0.85); border-radius: 8px;
    padding: 10px; z-index: 1000; width: 200px;
  }
  #adminMenu button {
    width: 100%; padding: 8px; margin: 6px 0; border: none; border-radius: 6px; background: #3366ff; color: white;
    font-weight: bold; cursor: pointer;
  }
  #dataTable {
    display: none; margin-top: 20px; background: rgba(35,35,62,0.8); padding: 15px; border-radius: 10px;
    max-width: 900px; overflow-x: auto;
  }
  #dataTable table {
    width: 100%; border-collapse: collapse;
  }
  #dataTable th, #dataTable td {
    padding: 10px; border: 1px solid #506dadaa; text-align: center;
  }
  #dataTable th {
    background: #1a264a;
    font-weight: 700;
  }
  .input-group {
    position: relative; margin: 20px 0;
  }
  input[type="text"] {
    width: 100%; padding: 14px 44px 14px 16px; font-size: 16px; border-radius: 10px; border: none;
    box-shadow: inset 0 0 8px #222; color: #111;
  }
  .scan-icon {
    position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; cursor: pointer; color: #1a73e8;
  }
  button.submit-btn {
    width: 100%; padding: 16px; font-size: 18px; background: #4CAF50; border: none; border-radius: 10px; color: white;
    cursor: pointer; font-weight: bold;
  }
</style>
</head>
<body>

<div class="admin-icon" id="adminIcon" title="Ù…Ø¯ÛŒØ±ÛŒØª">ğŸ‘¤</div>

<div id="adminMenu">
  <button onclick="loadSalesData()">ğŸ“Š Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
  <button onclick="downloadData()">ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ CSV</button>
  <button onclick="showDeleteModal()">ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
  <button onclick="logoutAdmin()">ğŸšª Ø®Ø±ÙˆØ¬</button>
</div>

<h1 style="text-align:center; margin-top:70px;">Ø«Ø¨Øª ÙØ±ÙˆØ´ Honor</h1>

<div style="max-width: 480px; margin: 14px auto;">
  <div class="input-group">
    <input type="text" id="imeiInput" placeholder="Ø³Ø±ÛŒØ§Ù„ IMEI Ø±Ø§ ÙˆØ§Ø±Ø¯ ÛŒØ§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯" />
    <span class="scan-icon" title="Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯">ğŸ“·</span>
  </div>
  <div class="input-group">
    <input type="text" id="modelInput" placeholder="Ù…Ø¯Ù„ Ú¯ÙˆØ´ÛŒ" />
  </div>
  <div class="input-group">
    <input type="text" id="cityInput" placeholder="Ø´Ù‡Ø±" />
  </div>
  <div class="input-group">
    <input type="text" id="phoneInput" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" />
  </div>
  <button class="submit-btn" onclick="submitSale()">Ø«Ø¨Øª ÙØ±ÙˆØ´</button>
</div>

<div id="dataTable">
  <h2>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´</h2>
  <table>
    <thead>
      <tr><th>IMEI</th><th>Ù…Ø¯Ù„</th><th>Ø´Ù‡Ø±</th><th>ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</th></tr>
    </thead>
    <tbody id="salesTbody"></tbody>
  </table>
</div>

<div id="deleteModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:2000;">
  <div style="background:#222; padding:30px; border-radius:12px; text-align:center; color:#eee;">
    <p>Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒ Ø®ÙˆØ§Ù‡ÛŒØ¯ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡ Ù‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ</p>
    <button onclick="deleteAllData()" style="margin-right:10px; padding:10px 20px; background:#ff4444; border:none; border-radius:10px; cursor:pointer;">Ø¨Ù„Ù‡ Ø­Ø°Ù Ú©Ù†</button>
    <button onclick="hideDeleteModal()" style="padding:10px 20px; background:#666; border:none; border-radius:10px; cursor:pointer;">Ø§Ù†ØµØ±Ø§Ù</button>
  </div>
</div>

<script>
  const API_BASE = 'https://honor-sales-worker.farsimen.workers.dev';

  // Ø­Ø§Ù„Øª Ø§Ø¯Ù…ÛŒÙ†
  let isAdminLoggedIn = localStorage.getItem('adminToken') === 'Honor2025Admin!';

  // Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ Ù…Ù†ÙˆÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ¶Ø¹ÛŒØª Ù„Ø§Ú¯ÛŒÙ†
  const adminIcon = document.getElementById('adminIcon');
  const adminMenu = document.getElementById('adminMenu');

  function toggleAdminMenu() {
    adminMenu.style.display = isAdminLoggedIn ? 'block' : 'none';
    if(!isAdminLoggedIn) document.getElementById('dataTable').style.display = 'none';
  }

  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù†Ú¯Ø§Ù… load
  window.onload = () => {
    toggleAdminMenu();
  };

  // ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ† (Ø±Ù…Ø²Ø¹Ø¨ÙˆØ± Ø¯Ø± prompt)
  adminIcon.onclick = () => {
    if (isAdminLoggedIn) {
      toggleAdminMenu();
      return;
    }
    const pass = prompt('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
    if (pass === 'Honor2025Admin!') {
      localStorage.setItem('adminToken', 'Honor2025Admin!');
      isAdminLoggedIn = true;
      toggleAdminMenu();
      alert('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²!');
    } else {
      alert('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!');
    }
  };

  function logoutAdmin(){
    localStorage.removeItem('adminToken');
    isAdminLoggedIn = false;
    toggleAdminMenu();
    alert('Ø®Ø±ÙˆØ¬ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
  }

  // Ø«Ø¨Øª ÙØ±ÙˆØ´ Ø¬Ø¯ÛŒØ¯
  async function submitSale() {
    const imei = document.getElementById('imeiInput').value.trim();
    const model = document.getElementById('modelInput').value.trim();
    const city = document.getElementById('cityInput').value.trim();
    const phone = document.getElementById('phoneInput').value.trim();

    if (!imei || imei.length !== 15) {
      alert('IMEI Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ 15 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯.');
      return;
    }
    if (!model) {
      alert('Ù…Ø¯Ù„ Ú¯ÙˆØ´ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
      return;
    }

    try {
      const res = await fetch(API_BASE + '/api/sales/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Seller-ID': 'frontend' },
        body: JSON.stringify({ imei, phone_model: model, city, phone_number: phone, sale_date: new Date().toISOString().split('T')[0] })
      });
      const data = await res.json();
      alert(data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ÙØ±ÙˆØ´');
      if (data.success) {
        document.getElementById('imeiInput').value = '';
        document.getElementById('modelInput').value = '';
        document.getElementById('cityInput').value = '';
        document.getElementById('phoneInput').value = '';
      }
    } catch(e) {
      alert('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ' + e.message);
    }
  }

  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´
  async function loadSalesData() {
    if (!isAdminLoggedIn) {
      alert('Ø§Ø¨ØªØ¯Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¯Ù…ÛŒÙ† ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯!');
      return;
    }
    try {
      const res = await fetch(API_BASE + '/api/sales/data', {
        headers: { 'Authorization': 'Bearer Honor2025Admin!' }
      });
      if(!res.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª');
      const result = await res.json();
      const tbody = document.getElementById('salesTbody');
      tbody.innerHTML = '';
      if(result.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</td></tr>';
      } else {
        result.data.forEach(row => {
          tbody.innerHTML += `<tr>
            <td>${row.imei}</td>
            <td>${row.phone_model}</td>
            <td>${row.city || '-'}</td>
            <td>${new Date(row.created_at).toLocaleDateString('fa-IR')}</td>
          </tr>`;
        });
      }
      document.getElementById('dataTable').style.display = 'block';
    } catch(e) {
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: ' + e.message);
    }
  }

  // Ø¯Ø§Ù†Ù„ÙˆØ¯ CSV
  async function downloadData() {
    if(!isAdminLoggedIn){
      alert('Ø§Ø¨ØªØ¯Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¯Ù…ÛŒÙ† ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯!');
      return;
    }
    try{
      const res = await fetch(API_BASE + '/api/sales/export', {
        headers: { 'Authorization': 'Bearer Honor2025Admin!' }
      });
      if(!res.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„');
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'honor_sales_export.csv';
      a.click();
      URL.revokeObjectURL(url);
    } catch(e){
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯: ' + e.message);
    }
  }

  // Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ Ù…ÙˆØ¯Ø§Ù„ Ø­Ø°Ù Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
  function showDeleteModal() {
    if(!isAdminLoggedIn){
      alert('Ø§Ø¨ØªØ¯Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¯Ù…ÛŒÙ† ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯!');
      return;
    }
    document.getElementById('deleteModal').style.display = 'flex';
  }
  function hideDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
  }

  // Ø­Ø°Ù Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
  async function deleteAllData() {
    try {
      const res = await fetch(API_BASE + '/api/admin/delete-all', {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer Honor2025Admin!' }
      });
      if(!res.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§');
      alert('ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯');
      hideDeleteModal();
      document.getElementById('dataTable').style.display = 'none';
    } catch(e) {
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù: ' + e.message);
    }
  }
</script>

</body>
</html>
