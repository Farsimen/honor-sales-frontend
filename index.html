<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>سیستم مدیریت فروش Honor</title>
<style>
  body {
    margin: 0; padding: 20px; font-family: Tahoma, sans-serif; background: linear-gradient(135deg, #0a0a23 0%, #181f3a 50%, #1a164e 100%);
    color: white; min-height: 100vh;
  }
  .admin-icon {
    position: fixed; top: 20px; right: 20px; width: 48px; height: 48px; background: rgba(255,255,255,0.16);
    border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 1000;
    font-size: 24px;
  }
  #adminMenu {
    display: none; position: fixed; top: 80px; right: 20px; background: rgba(20,20,40,0.85); border-radius: 8px;
    padding: 10px; z-index: 1000; width: 200px;
  }
  #adminMenu button {
    width: 100%; padding: 8px; margin: 6px 0; border: none; border-radius: 6px; background: #3366ff; color: white;
    font-weight: bold; cursor: pointer;
  }
  #dataTable {
    display: none; margin-top: 20px; background: rgba(35,35,62,0.8); padding: 15px; border-radius: 10px;
    max-width: 900px; overflow-x: auto;
  }
  #dataTable table {
    width: 100%; border-collapse: collapse;
  }
  #dataTable th, #dataTable td {
    padding: 10px; border: 1px solid #506dadaa; text-align: center;
  }
  #dataTable th {
    background: #1a264a;
    font-weight: 700;
  }
  .input-group {
    position: relative; margin: 20px 0;
  }
  input[type="text"] {
    width: 100%; padding: 14px 44px 14px 16px; font-size: 16px; border-radius: 10px; border: none;
    box-shadow: inset 0 0 8px #222; color: #111;
  }
  .scan-icon {
    position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 18px; cursor: pointer; color: #1a73e8;
  }
  button.submit-btn {
    width: 100%; padding: 16px; font-size: 18px; background: #4CAF50; border: none; border-radius: 10px; color: white;
    cursor: pointer; font-weight: bold;
  }
</style>
</head>
<body>

<div class="admin-icon" id="adminIcon" title="مدیریت">👤</div>

<div id="adminMenu">
  <button onclick="loadSalesData()">📊 مشاهده اطلاعات</button>
  <button onclick="downloadData()">📥 دانلود CSV</button>
  <button onclick="showDeleteModal()">🗑️ حذف همه داده‌ها</button>
  <button onclick="logoutAdmin()">🚪 خروج</button>
</div>

<h1 style="text-align:center; margin-top:70px;">ثبت فروش Honor</h1>

<div style="max-width: 480px; margin: 14px auto;">
  <div class="input-group">
    <input type="text" id="imeiInput" placeholder="سریال IMEI را وارد یا اسکن کنید" />
    <span class="scan-icon" title="اسکن بارکد">📷</span>
  </div>
  <div class="input-group">
    <input type="text" id="modelInput" placeholder="مدل گوشی" />
  </div>
  <div class="input-group">
    <input type="text" id="cityInput" placeholder="شهر" />
  </div>
  <div class="input-group">
    <input type="text" id="phoneInput" placeholder="شماره تماس" />
  </div>
  <button class="submit-btn" onclick="submitSale()">ثبت فروش</button>
</div>

<div id="dataTable">
  <h2>اطلاعات فروش</h2>
  <table>
    <thead>
      <tr><th>IMEI</th><th>مدل</th><th>شهر</th><th>تاریخ ثبت</th></tr>
    </thead>
    <tbody id="salesTbody"></tbody>
  </table>
</div>

<div id="deleteModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:2000;">
  <div style="background:#222; padding:30px; border-radius:12px; text-align:center; color:#eee;">
    <p>آیا مطمئن هستید که می خواهید همه داده ها حذف شوند؟</p>
    <button onclick="deleteAllData()" style="margin-right:10px; padding:10px 20px; background:#ff4444; border:none; border-radius:10px; cursor:pointer;">بله حذف کن</button>
    <button onclick="hideDeleteModal()" style="padding:10px 20px; background:#666; border:none; border-radius:10px; cursor:pointer;">انصراف</button>
  </div>
</div>

<script>
  const API_BASE = 'https://honor-sales-worker.farsimen.workers.dev';

  // حالت ادمین
  let isAdminLoggedIn = localStorage.getItem('adminToken') === 'Honor2025Admin!';

  // نمایش/مخفی منوی ادمین بر اساس وضعیت لاگین
  const adminIcon = document.getElementById('adminIcon');
  const adminMenu = document.getElementById('adminMenu');

  function toggleAdminMenu() {
    adminMenu.style.display = isAdminLoggedIn ? 'block' : 'none';
    if(!isAdminLoggedIn) document.getElementById('dataTable').style.display = 'none';
  }

  // بارگذاری وضعیت هنگام load
  window.onload = () => {
    toggleAdminMenu();
  };

  // ورود ادمین (رمزعبور در prompt)
  adminIcon.onclick = () => {
    if (isAdminLoggedIn) {
      toggleAdminMenu();
      return;
    }
    const pass = prompt('رمز عبور مدیریت را وارد کنید:');
    if (pass === 'Honor2025Admin!') {
      localStorage.setItem('adminToken', 'Honor2025Admin!');
      isAdminLoggedIn = true;
      toggleAdminMenu();
      alert('ورود موفقیت‌آمیز!');
    } else {
      alert('رمز عبور اشتباه است!');
    }
  };

  function logoutAdmin(){
    localStorage.removeItem('adminToken');
    isAdminLoggedIn = false;
    toggleAdminMenu();
    alert('خروج انجام شد');
  }

  // ثبت فروش جدید
  async function submitSale() {
    const imei = document.getElementById('imeiInput').value.trim();
    const model = document.getElementById('modelInput').value.trim();
    const city = document.getElementById('cityInput').value.trim();
    const phone = document.getElementById('phoneInput').value.trim();

    if (!imei || imei.length !== 15) {
      alert('IMEI باید دقیقاً 15 رقم باشد.');
      return;
    }
    if (!model) {
      alert('مدل گوشی را وارد کنید.');
      return;
    }

    try {
      const res = await fetch(API_BASE + '/api/sales/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Seller-ID': 'frontend' },
        body: JSON.stringify({ imei, phone_model: model, city, phone_number: phone, sale_date: new Date().toISOString().split('T')[0] })
      });
      const data = await res.json();
      alert(data.message || 'خطا در ثبت فروش');
      if (data.success) {
        document.getElementById('imeiInput').value = '';
        document.getElementById('modelInput').value = '';
        document.getElementById('cityInput').value = '';
        document.getElementById('phoneInput').value = '';
      }
    } catch(e) {
      alert('خطای شبکه: ' + e.message);
    }
  }

  // بارگذاری اطلاعات فروش
  async function loadSalesData() {
    if (!isAdminLoggedIn) {
      alert('ابتدا به عنوان ادمین وارد شوید!');
      return;
    }
    try {
      const res = await fetch(API_BASE + '/api/sales/data', {
        headers: { 'Authorization': 'Bearer Honor2025Admin!' }
      });
      if(!res.ok) throw new Error('خطا در دریافت اطلاعات');
      const result = await res.json();
      const tbody = document.getElementById('salesTbody');
      tbody.innerHTML = '';
      if(result.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">داده‌ای موجود نیست</td></tr>';
      } else {
        result.data.forEach(row => {
          tbody.innerHTML += `<tr>
            <td>${row.imei}</td>
            <td>${row.phone_model}</td>
            <td>${row.city || '-'}</td>
            <td>${new Date(row.created_at).toLocaleDateString('fa-IR')}</td>
          </tr>`;
        });
      }
      document.getElementById('dataTable').style.display = 'block';
    } catch(e) {
      alert('خطا در بارگذاری داده‌ها: ' + e.message);
    }
  }

  // دانلود CSV
  async function downloadData() {
    if(!isAdminLoggedIn){
      alert('ابتدا به عنوان ادمین وارد شوید!');
      return;
    }
    try{
      const res = await fetch(API_BASE + '/api/sales/export', {
        headers: { 'Authorization': 'Bearer Honor2025Admin!' }
      });
      if(!res.ok) throw new Error('خطا در دانلود فایل');
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'honor_sales_export.csv';
      a.click();
      URL.revokeObjectURL(url);
    } catch(e){
      alert('خطا در دانلود: ' + e.message);
    }
  }

  // نمایش/مخفی مودال حذف داده‌ها
  function showDeleteModal() {
    if(!isAdminLoggedIn){
      alert('ابتدا به عنوان ادمین وارد شوید!');
      return;
    }
    document.getElementById('deleteModal').style.display = 'flex';
  }
  function hideDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
  }

  // حذف همه داده‌ها
  async function deleteAllData() {
    try {
      const res = await fetch(API_BASE + '/api/admin/delete-all', {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer Honor2025Admin!' }
      });
      if(!res.ok) throw new Error('خطا در حذف داده‌ها');
      alert('تمام داده‌ها حذف شدند');
      hideDeleteModal();
      document.getElementById('dataTable').style.display = 'none';
    } catch(e) {
      alert('خطا در حذف: ' + e.message);
    }
  }
</script>

</body>
</html>
