<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ÿ≥€åÿ≥ÿ™ŸÖ ŸÖÿØ€åÿ±€åÿ™ ŸÅÿ±Ÿàÿ¥ Honor</title>
<link href="https://cdn.jsdelivr.net/npm/vazirmatn@33.0.3/Vazirmatn-font-face.css" rel="stylesheet" />
<style>
  * {
    box-sizing: border-box;
  }
  
  body {
    margin: 0;
    padding: 20px;
    font-family: 'Vazirmatn', 'Segoe UI', Tahoma, Arial, sans-serif;
    background: linear-gradient(135deg, #162447 0%, #1f4068 55%, #3a416f 100%);
    color: white;
    min-height: 100vh;
    line-height: 1.6;
  }
  
  .container {
    max-width: 500px;
    margin: 0 auto;
    position: relative;
  }
  
  /* Header Styles */
  .header {
    text-align: center;
    margin: 60px 0 40px 0;
  }
  
  .logo {
    width: 80px;
    height: 80px;
    background: linear-gradient(45deg, #3ab54a, #3995e7);
    border-radius: 20px;
    margin: 0 auto 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    font-weight: bold;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: pulse 2s infinite;
    color: white;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  h1 {
    font-size: 28px;
    margin: 0;
    font-weight: 500;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }
  
  /* Admin Panel */
  .admin-icon {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    font-size: 24px;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }
  
  .admin-icon:hover {
    transform: scale(1.1);
    background: rgba(255,255,255,0.3);
  }
  
  .admin-logged {
    background: rgba(55, 196, 83, 0.8) !important;
    border-color: rgba(55, 196, 83, 0.6) !important;
  }
  
  #adminMenu {
    display: none;
    position: fixed;
    top: 90px;
    right: 20px;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 16px;
    padding: 20px;
    z-index: 1000;
    width: 240px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    animation: slideIn 0.3s ease;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  #adminMenu button {
    width: 100%;
    padding: 12px 16px;
    margin: 8px 0;
    border: none;
    border-radius: 12px;
    background: linear-gradient(45deg, #1f4068, #3a416f);
    color: white;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: inherit;
  }
  
  #adminMenu button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    background: linear-gradient(45deg, #2a5085, #4a5a8f);
  }
  
  /* Form Styles */
  .form-card {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 24px;
    padding: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  
  .input-group {
    position: relative;
    margin: 24px 0;
  }
  
  .input-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: rgba(255,255,255,0.9);
    font-size: 14px;
  }
  
  input[type="text"], input[type="date"], select {
    width: 100%;
    padding: 16px 50px 16px 20px;
    font-size: 17px;
    border-radius: 14px;
    border: 2px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.95);
    color: #333;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    font-family: inherit;
    box-shadow: 0 2px 8px rgba(34,34,34,0.1);
  }
  
  input[type="text"]:focus, input[type="date"]:focus, select:focus {
    outline: none;
    border-color: #3995e7;
    background: rgba(255,255,255,0.98);
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }
  
  input[type="text"]::placeholder {
    color: #666;
  }
  
  /* Date Input Styles */
  input[type="date"] {
    padding: 16px 20px;
    direction: ltr;
  }
  
  input[type="date"]::-webkit-calendar-picker-indicator {
    background: url('üìÖ') no-repeat center;
    background-size: 16px;
    cursor: pointer;
  }
  
  .date-display {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    color: #666;
    pointer-events: none;
    background: rgba(255,255,255,0.9);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
  }
  
  .scan-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-10%);
    font-size: 20px;
    cursor: pointer;
    color: #1f4068;
    transition: all 0.3s ease;
    background: rgba(31,64,104,0.1);
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .scan-icon:hover {
    background: rgba(31,64,104,0.2);
    transform: translateY(-10%) scale(1.1);
  }
  
  button.submit-btn {
    width: 100%;
    padding: 18px;
    font-size: 20px;
    background: linear-gradient(90deg, #3ab54a 70%, #3995e7 100%);
    border: none;
    border-radius: 14px;
    color: white;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(25,118,210,0.1);
    position: relative;
    overflow: hidden;
    font-family: inherit;
  }
  
  button.submit-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
  }
  
  button.submit-btn:active {
    transform: translateY(-1px);
  }
  
  button.submit-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }
  
  /* Loading Animation */
  .loading {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }
  
  .spinner {
    width: 24px;
    height: 24px;
    border: 3px solid rgba(255,255,255,0.3);
    border-top: 3px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Data Table */
  #dataTable {
    display: none;
    margin-top: 30px;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
    padding: 25px;
    border-radius: 20px;
    max-width: 900px;
    overflow-x: auto;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
  }
  
  #dataTable h2 {
    margin-top: 0;
    color: white;
    font-weight: 500;
    text-align: center;
    margin-bottom: 25px;
  }
  
  #dataTable table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  
  #dataTable th,
  #dataTable td {
    padding: 12px 15px;
    border: 1px solid rgba(255,255,255,0.2);
    text-align: center;
  }
  
  #dataTable th {
    background: rgba(255,255,255,0.2);
    font-weight: 600;
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  #dataTable td {
    background: rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.9);
  }
  
  #dataTable table tr:nth-child(even) td {
    background: rgba(25,40,90,0.36);
  }
  
  #dataTable table tr:hover td {
    background: rgba(255,255,255,0.15);
  }
  
  /* Modal */
  #deleteModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(10px);
    align-items: center;
    justify-content: center;
    z-index: 2000;
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .modal-content {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    color: white;
    max-width: 400px;
    margin: 20px;
    box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
  }
  
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .modal-content h3 {
    margin-top: 0;
    color: #ff6b6b;
  }
  
  .modal-buttons {
    display: flex;
    gap: 15px;
    margin-top: 25px;
    justify-content: center;
  }
  
  .modal-buttons button {
    padding: 12px 24px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    font-family: inherit;
  }
  
  .btn-danger {
    background: linear-gradient(45deg, #ff4757, #ff3838);
    color: white;
  }
  
  .btn-secondary {
    background: rgba(255,255,255,0.2);
    color: white;
  }
  
  .modal-buttons button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
  }
  
  /* Success/Error Messages */
  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 15px 25px;
    border-radius: 12px;
    color: white;
    font-weight: 600;
    z-index: 3000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    backdrop-filter: blur(10px);
    animation: slideDown 0.3s ease;
    max-width: 90%;
    text-align: center;
  }
  
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }
  
  .toast.success {
    background: linear-gradient(45deg, #2ed573, #7bed9f);
  }
  
  .toast.error {
    background: linear-gradient(45deg, #ff4757, #ff6b7a);
  }
  
  .toast.fadeOut {
    animation: slideUp 0.3s ease forwards;
  }
  
  /* Responsive */
  @media (max-width: 600px) {
    body {
      padding: 10px;
    }
    
    .container {
      max-width: 100%;
    }
    
    .form-card {
      padding: 20px;
      margin: 20px 0;
    }
    
    .admin-icon {
      width: 48px;
      height: 48px;
      font-size: 20px;
    }
    
    #adminMenu {
      width: 200px;
      right: 10px;
    }
    
    h1 {
      font-size: 24px;
    }
    
    .logo {
      width: 60px;
      height: 60px;
      font-size: 28px;
    }
    
    #dataTable {
      padding: 15px;
    }
    
    #dataTable th,
    #dataTable td {
      padding: 8px 10px;
      font-size: 14px;
    }
    
    .modal-content {
      padding: 25px;
      margin: 10px;
    }
    
    .modal-buttons {
      flex-direction: column;
      gap: 10px;
    }
    
    .modal-buttons button {
      width: 100%;
    }
  }
  
  /* Input validation styles */
  input[type="text"].error, input[type="date"].error {
    border-color: #ff4757;
    background: rgba(255,71,87,0.1);
  }
  
  input[type="text"].success, input[type="date"].success {
    border-color: #2ed573;
  }
  
  /* Smooth scrolling */
  html {
    scroll-behavior: smooth;
  }
</style>
</head>
<body>

<div class="admin-icon" id="adminIcon" title="ŸÖÿØ€åÿ±€åÿ™">üë§</div>

<div id="adminMenu">
  <button onclick="loadSalesData()">
    <span>üìä</span>
    <span>ŸÖÿ¥ÿßŸáÿØŸá ÿßÿ∑ŸÑÿßÿπÿßÿ™</span>
  </button>
  <button onclick="downloadData()">
    <span>üì•</span>
    <span>ÿØÿßŸÜŸÑŸàÿØ CSV</span>
  </button>
  <button onclick="showDeleteModal()">
    <span>üóëÔ∏è</span>
    <span>ÿ≠ÿ∞ŸÅ ŸáŸÖŸá ÿØÿßÿØŸá‚ÄåŸáÿß</span>
  </button>
  <button onclick="logoutAdmin()">
    <span>üö™</span>
    <span>ÿÆÿ±Ÿàÿ¨</span>
  </button>
</div>

<div class="container">
  <div class="header">
    <div class="logo">H</div>
    <h1>ÿ≥€åÿ≥ÿ™ŸÖ ŸÖÿØ€åÿ±€åÿ™ ŸÅÿ±Ÿàÿ¥ Honor</h1>
  </div>

  <div class="form-card">
    <div class="input-group">
      <label class="input-label">ÿ≥ÿ±€åÿßŸÑ IMEI</label>
      <input type="text" id="imeiInput" placeholder="ÿ≥ÿ±€åÿßŸÑ IMEI ÿ±ÿß Ÿàÿßÿ±ÿØ €åÿß ÿßÿ≥⁄©ŸÜ ⁄©ŸÜ€åÿØ" maxlength="15" />
      <span class="scan-icon" title="ÿßÿ≥⁄©ŸÜ ÿ®ÿßÿ±⁄©ÿØ">üì∑</span>
    </div>
    
    <div class="input-group">
      <label class="input-label">ŸÖÿØŸÑ ⁄ØŸàÿ¥€å</label>
      <input type="text" id="modelInput" placeholder="ŸÖÿ´ÿßŸÑ: Honor X5B" />
    </div>
    
    <div class="input-group">
      <label class="input-label">ÿ¥Ÿáÿ±</label>
      <input type="text" id="cityInput" placeholder="ŸÜÿßŸÖ ÿ¥Ÿáÿ± ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ" />
    </div>
    
    <div class="input-group">
      <label class="input-label">ÿ¥ŸÖÿßÿ±Ÿá ÿ™ŸÖÿßÿ≥</label>
      <input type="text" id="phoneInput" placeholder="09xxxxxxxxx" maxlength="11" />
    </div>
    
    <div class="input-group">
      <label class="input-label">ÿ™ÿßÿ±€åÿÆ ÿ´ÿ®ÿ™ ŸÅÿ±Ÿàÿ¥</label>
      <input type="date" id="dateInput" />
      <span class="date-display" id="dateDisplay"></span>
    </div>
    
    <button class="submit-btn" onclick="submitSale()" id="submitBtn">
      <span id="submitText">ÿ´ÿ®ÿ™ ŸÅÿ±Ÿàÿ¥</span>
      <div class="loading" id="loading">
        <div class="spinner"></div>
      </div>
    </button>
  </div>
</div>

<div id="dataTable">
  <h2>üìä ÿßÿ∑ŸÑÿßÿπÿßÿ™ ŸÅÿ±Ÿàÿ¥</h2>
  <table>
    <thead>
      <tr>
        <th>IMEI</th>
        <th>ŸÖÿØŸÑ</th>
        <th>ÿ¥Ÿáÿ±</th>
        <th>ÿ¥ŸÖÿßÿ±Ÿá ÿ™ŸÖÿßÿ≥</th>
        <th>ÿ™ÿßÿ±€åÿÆ ÿ´ÿ®ÿ™</th>
      </tr>
    </thead>
    <tbody id="salesTbody"></tbody>
  </table>
</div>

<div id="deleteModal">
  <div class="modal-content">
    <h3>‚ö†Ô∏è Ÿáÿ¥ÿØÿßÿ±</h3>
    <p>ÿ¢€åÿß ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ⁄©Ÿá ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ŸáŸÖŸá ÿØÿßÿØŸá‚ÄåŸáÿß ÿ≠ÿ∞ŸÅ ÿ¥ŸàŸÜÿØÿü<br>
    ÿß€åŸÜ ÿπŸÖŸÑ ŸÇÿßÿ®ŸÑ ÿ®ÿ±⁄Øÿ¥ÿ™ ŸÜ€åÿ≥ÿ™!</p>
    <div class="modal-buttons">
      <button class="btn-danger" onclick="deleteAllData()">ÿ®ŸÑŸáÿå ÿ≠ÿ∞ŸÅ ⁄©ŸÜ</button>
      <button class="btn-secondary" onclick="hideDeleteModal()">ÿßŸÜÿµÿ±ÿßŸÅ</button>
    </div>
  </div>
</div>

<script>
  const API_BASE = 'https://honor-sales-worker.farsimen.workers.dev';

  // ÿ≠ÿßŸÑÿ™ ÿßÿØŸÖ€åŸÜ
  let isAdminLoggedIn = localStorage.getItem('adminToken') === 'Honor2025Admin!';

  // ŸÜŸÖÿß€åÿ¥/ŸÖÿÆŸÅ€å ŸÖŸÜŸà€å ÿßÿØŸÖ€åŸÜ ÿ®ÿ± ÿßÿ≥ÿßÿ≥ Ÿàÿ∂ÿπ€åÿ™ ŸÑÿß⁄Ø€åŸÜ
  const adminIcon = document.getElementById('adminIcon');
  const adminMenu = document.getElementById('adminMenu');

  // ÿ™ÿßÿ®ÿπ ÿ™ÿ®ÿØ€åŸÑ ÿ™ÿßÿ±€åÿÆ ŸÖ€åŸÑÿßÿØ€å ÿ®Ÿá ÿ¥ŸÖÿ≥€å
  function gregorianToJalali(gy, gm, gd) {
    const g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
    let jy, jm, jd, gy2, days;
    
    if (gy <= 1600) {
      jy = 0; gy -= 621;
    } else {
      jy = 979; gy -= 1600; gy2 = (gy > 2) ? (gy + 1) : gy;
    }
    
    days = (365 * gy) + ((gy2 + 3) >> 2) + g_d_m[gm - 1] + gd;
    if ((gm > 2) && (((gy % 4) === 0) && (((gy % 100) !== 0) || ((gy % 400) === 0)))) ++days;
    jy += 33 * (days >> 12053);
    days %= 12053;
    jy += 4 * (days >> 1461);
    days %= 1461;
    if (days > 365) {
      jy += ((days - 1) >> 365);
      days = (days - 1) % 365;
    }
    
    if (days < 186) {
      jm = 1 + (days >> 31);
      jd = 1 + (days % 31);
    } else {
      jm = 7 + ((days - 186) >> 30);
      jd = 1 + ((days - 186) % 30);
    }
    
    return { year: jy, month: jm, day: jd };
  }

  // ÿ™ÿßÿ®ÿπ ÿ™ÿ®ÿØ€åŸÑ ÿ™ÿßÿ±€åÿÆ ÿ¥ŸÖÿ≥€å ÿ®Ÿá ŸÖ€åŸÑÿßÿØ€å
  function jalaliToGregorian(jy, jm, jd) {
    let gy, gm, gd2, days;
    
    if (jy <= 979) {
      gy = 1600; jy -= 979;
    } else {
      gy = 621; jy -= 979;
    }
    
    if (jm < 7) {
      days = (jm - 1) * 31;
    } else {
      days = (jm - 7) * 30 + 186;
    }
    days += (365 * jy) + ((jy >> 2)) + jd - 1;
    
    gy += 400 * (days >> 146097);
    days %= 146097;
    
    if (days >= 36525) {
      days--;
      gy += 100 * (days >> 36524);
      days %= 36524;
      if (days >= 365) days++;
    }
    
    gy += 4 * (days >> 1461);
    days %= 1461;
    
    if (days >= 366) {
      days--;
      gy += (days >> 365);
      days = days % 365;
    }
    
    gd2 = days + 1;
    
    const sal_a = [0, 31, ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
    gm = 0;
    while (gm < 13 && gd2 > sal_a[gm]) {
      gd2 -= sal_a[gm++];
    }
    
    return { year: gy, month: gm, day: gd2 };
  }

  // ÿ™ÿßÿ®ÿπ ŸÜŸÖÿß€åÿ¥ ÿ™ÿßÿ±€åÿÆ ÿ¥ŸÖÿ≥€å
  function displayJalaliDate(gregorianDate) {
    if (!gregorianDate) return '';
    
    const date = new Date(gregorianDate);
    const jalali = gregorianToJalali(date.getFullYear(), date.getMonth() + 1, date.getDate());
    
    const monthNames = [
      'ŸÅÿ±Ÿàÿ±ÿØ€åŸÜ', 'ÿßÿ±ÿØ€åÿ®Ÿáÿ¥ÿ™', 'ÿÆÿ±ÿØÿßÿØ', 'ÿ™€åÿ±', 'ŸÖÿ±ÿØÿßÿØ', 'ÿ¥Ÿáÿ±€åŸàÿ±',
      'ŸÖŸáÿ±', 'ÿ¢ÿ®ÿßŸÜ', 'ÿ¢ÿ∞ÿ±', 'ÿØ€å', 'ÿ®ŸáŸÖŸÜ', 'ÿßÿ≥ŸÅŸÜÿØ'
    ];
    
    return `${jalali.day} ${monthNames[jalali.month - 1]} ${jalali.year}`;
  }

  // ÿ™ŸÜÿ∏€åŸÖ ÿ™ÿßÿ±€åÿÆ Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂ Ÿà ŸÜŸÖÿß€åÿ¥
  function initializeDateInput() {
    const dateInput = document.getElementById('dateInput');
    const dateDisplay = document.getElementById('dateDisplay');
    
    // ÿ™ŸÜÿ∏€åŸÖ ÿ™ÿßÿ±€åÿÆ ÿßŸÖÿ±Ÿàÿ≤
    const today = new Date();
    const todayString = today.toISOString().split('T')[0];
    dateInput.value = todayString;
    
    // ŸÜŸÖÿß€åÿ¥ ÿ™ÿßÿ±€åÿÆ ÿ¥ŸÖÿ≥€å
    dateDisplay.textContent = displayJalaliDate(todayString);
    
    // ÿ±Ÿà€åÿØÿßÿØ ÿ™ÿ∫€å€åÿ± ÿ™ÿßÿ±€åÿÆ
    dateInput.addEventListener('change', (e) => {
      dateDisplay.textContent = displayJalaliDate(e.target.value);
    });
  }

  function toggleAdminMenu() {
    if (adminMenu.style.display === 'block') {
      adminMenu.style.display = 'none';
    } else {
      adminMenu.style.display = isAdminLoggedIn ? 'block' : 'none';
    }
    if(!isAdminLoggedIn) document.getElementById('dataTable').style.display = 'none';
  }

  // ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å Ÿàÿ∂ÿπ€åÿ™ ŸáŸÜ⁄ØÿßŸÖ load
  window.onload = () => {
    if (isAdminLoggedIn) {
      adminIcon.classList.add('admin-logged');
    }
    initializeDateInput();
  };

  // ÿ®ÿ≥ÿ™ŸÜ ŸÖŸÜŸà ÿ®ÿß ⁄©ŸÑ€å⁄© ÿÆÿßÿ±ÿ¨ ÿßÿ≤ ÿ¢ŸÜ
  document.addEventListener('click', (e) => {
    if (!adminIcon.contains(e.target) && !adminMenu.contains(e.target)) {
      adminMenu.style.display = 'none';
    }
  });

  // Ÿàÿ±ŸàÿØ ÿßÿØŸÖ€åŸÜ
  adminIcon.onclick = (e) => {
    e.stopPropagation();
    if (isAdminLoggedIn) {
      toggleAdminMenu();
      return;
    }
    const pass = prompt('ÿ±ŸÖÿ≤ ÿπÿ®Ÿàÿ± ŸÖÿØ€åÿ±€åÿ™ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ:');
    if (pass === 'Honor2025Admin!') {
      localStorage.setItem('adminToken', 'Honor2025Admin!');
      isAdminLoggedIn = true;
      adminIcon.classList.add('admin-logged');
      toggleAdminMenu();
      showToast('Ÿàÿ±ŸàÿØ ŸÖŸàŸÅŸÇ€åÿ™‚Äåÿ¢ŸÖ€åÿ≤!', 'success');
    } else if (pass !== null) {
      showToast('ÿ±ŸÖÿ≤ ÿπÿ®Ÿàÿ± ÿßÿ¥ÿ™ÿ®ÿßŸá ÿßÿ≥ÿ™!', 'error');
    }
  };

  function logoutAdmin(){
    localStorage.removeItem('adminToken');
    isAdminLoggedIn = false;
    adminIcon.classList.remove('admin-logged');
    adminMenu.style.display = 'none';
    document.getElementById('dataTable').style.display = 'none';
    showToast('ÿÆÿ±Ÿàÿ¨ ÿßŸÜÿ¨ÿßŸÖ ÿ¥ÿØ', 'success');
  }

  // ŸÜŸÖÿß€åÿ¥ Ÿæ€åÿßŸÖ toast
  function showToast(text, type = 'success') {
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
      existingToast.remove();
    }
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = text;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('fadeOut');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 4000);
  }

  // ÿßÿπÿ™ÿ®ÿßÿ±ÿ≥ŸÜÿ¨€å ŸÅ€åŸÑÿØŸáÿß
  function validateField(input, isValid) {
    input.classList.remove('error', 'success');
    if (isValid) {
      input.classList.add('success');
    } else {
      input.classList.add('error');
    }
  }

  // ÿ´ÿ®ÿ™ ŸÅÿ±Ÿàÿ¥ ÿ¨ÿØ€åÿØ
  async function submitSale() {
    const imei = document.getElementById('imeiInput').value.trim();
    const model = document.getElementById('modelInput').value.trim();
    const city = document.getElementById('cityInput').value.trim();
    const phone = document.getElementById('phoneInput').value.trim();
    const saleDate = document.getElementById('dateInput').value;

    // ÿßÿπÿ™ÿ®ÿßÿ±ÿ≥ŸÜÿ¨€å
    const imeiInput = document.getElementById('imeiInput');
    const modelInput = document.getElementById('modelInput');
    const dateInput = document.getElementById('dateInput');

    if (!imei || imei.length !== 15) {
      validateField(imeiInput, false);
      showToast('IMEI ÿ®ÿß€åÿØ ÿØŸÇ€åŸÇÿßŸã 15 ÿ±ŸÇŸÖ ÿ®ÿßÿ¥ÿØ.', 'error');
      imeiInput.focus();
      return;
    }
    validateField(imeiInput, true);

    if (!model) {
      validateField(modelInput, false);
      showToast('ŸÖÿØŸÑ ⁄ØŸàÿ¥€å ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ.', 'error');
      modelInput.focus();
      return;
    }
    validateField(modelInput, true);

    if (!saleDate) {
      validateField(dateInput, false);
      showToast('ÿ™ÿßÿ±€åÿÆ ÿ´ÿ®ÿ™ ŸÅÿ±Ÿàÿ¥ ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.', 'error');
      dateInput.focus();
      return;
    }
    validateField(dateInput, true);

    // ŸÜŸÖÿß€åÿ¥ ŸÑŸàÿØ€åŸÜ⁄Ø
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loading = document.getElementById('loading');
    
    submitBtn.disabled = true;
    submitText.style.opacity = '0';
    loading.style.display = 'block';

    try {
      const res = await fetch(API_BASE + '/api/sales/register', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json', 
          'X-Seller-ID': 'frontend' 
        },
        body: JSON.stringify({ 
          imei, 
          phone_model: model, 
          city, 
          phone_number: phone, 
          sale_date: saleDate
        })
      });
      
      const data = await res.json();
      
      if (data.success) {
        showToast(data.message || 'ŸÅÿ±Ÿàÿ¥ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿ´ÿ®ÿ™ ÿ¥ÿØ!', 'success');
        // Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ ŸÅÿ±ŸÖ
        document.getElementById('imeiInput').value = '';
        document.getElementById('modelInput').value = '';
        document.getElementById('cityInput').value = '';
        document.getElementById('phoneInput').value = '';
        
        // ÿ™ŸÜÿ∏€åŸÖ ŸÖÿ¨ÿØÿØ ÿ™ÿßÿ±€åÿÆ ÿßŸÖÿ±Ÿàÿ≤
        const today = new Date();
        const todayString = today.toISOString().split('T')[0];
        document.getElementById('dateInput').value = todayString;
        document.getElementById('dateDisplay').textContent = displayJalaliDate(todayString);
        
        // ÿ≠ÿ∞ŸÅ ⁄©ŸÑÿßÿ≥‚ÄåŸáÿß€å validation
        document.querySelectorAll('input[type="text"], input[type="date"]').forEach(input => {
          input.classList.remove('error', 'success');
        });
      } else {
        showToast(data.message || 'ÿÆÿ∑ÿß ÿØÿ± ÿ´ÿ®ÿ™ ŸÅÿ±Ÿàÿ¥', 'error');
      }
    } catch(e) {
      showToast('ÿÆÿ∑ÿß€å ÿ¥ÿ®⁄©Ÿá: ' + e.message, 'error');
    } finally {
      // ŸÖÿÆŸÅ€å ⁄©ÿ±ÿØŸÜ ŸÑŸàÿØ€åŸÜ⁄Ø
      submitBtn.disabled = false;
      submitText.style.opacity = '1';
      loading.style.display = 'none';
    }
  }

  // ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿßÿ∑ŸÑÿßÿπÿßÿ™ ŸÅÿ±Ÿàÿ¥
  async function loadSalesData() {
    if (!isAdminLoggedIn) {
      showToast('ÿßÿ®ÿ™ÿØÿß ÿ®Ÿá ÿπŸÜŸàÿßŸÜ ÿßÿØŸÖ€åŸÜ Ÿàÿßÿ±ÿØ ÿ¥Ÿà€åÿØ!', 'error');
      return;
    }
    
    try {
      const res = await fetch(API_BASE + '/api/sales/data', {
        headers: { 'Authorization': 'Bearer Honor2025Admin!' }
      });
      
      if(!res.ok) throw new Error('ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿßÿ∑ŸÑÿßÿπÿßÿ™');
      
      const result = await res.json();
      const tbody = document.getElementById('salesTbody');
      tbody.innerHTML = '';
      
      if(result.data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">ÿØÿßÿØŸá‚Äåÿß€å ŸÖŸàÿ¨ŸàÿØ ŸÜ€åÿ≥ÿ™</td></tr>';
      } else {
        result.data.forEach(row => {
          const persianDate = displayJalaliDate(row.sale_date || row.created_at);
          tbody.innerHTML += `<tr>
            <td>${row.imei}</td>
            <td>${row.phone_model}</td>
            <td>${row.city || '-'}</td>
            <td>${row.phone_number || '-'}</td>
            <td>${persianDate}</td>
          </tr>`;
        });
      }
      
      document.getElementById('dataTable').style.display = 'block';
      adminMenu.style.display = 'none';
      showToast(`${result.data.length} ÿ±⁄©Ÿàÿ±ÿØ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¥ÿØ`, 'success');
    } catch(e) {
      showToast('ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿØÿßÿØŸá‚ÄåŸáÿß: ' + e.message, 'error');
    }
  }

  // ÿØÿßŸÜŸÑŸàÿØ CSV
  async function downloadData() {
    if(!isAdminLoggedIn){
      showToast('ÿßÿ®ÿ™ÿØÿß ÿ®Ÿá ÿπŸÜŸàÿßŸÜ ÿßÿØŸÖ€åŸÜ Ÿàÿßÿ±ÿØ ÿ¥Ÿà€åÿØ!', 'error');
      return;
    }
    
    try{
      const res = await fetch(API_BASE + '/api/sales/export', {
        headers: { 'Authorization': 'Bearer Honor2025Admin!' }
      });
      
      if(!res.ok) throw new Error('ÿÆÿ∑ÿß ÿØÿ± ÿØÿßŸÜŸÑŸàÿØ ŸÅÿß€åŸÑ');
      
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `honor_sales_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('ŸÅÿß€åŸÑ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿØÿßŸÜŸÑŸàÿØ ÿ¥ÿØ', 'success');
      adminMenu.style.display = 'none';
    } catch(e){
      showToast('ÿÆÿ∑ÿß ÿØÿ± ÿØÿßŸÜŸÑŸàÿØ: ' + e.message, 'error');
    }
  }

  // ŸÜŸÖÿß€åÿ¥/ŸÖÿÆŸÅ€å ŸÖŸàÿØÿßŸÑ ÿ≠ÿ∞ŸÅ ÿØÿßÿØŸá‚ÄåŸáÿß
  function showDeleteModal() {
    if(!isAdminLoggedIn){
      showToast('ÿßÿ®ÿ™ÿØÿß ÿ®Ÿá ÿπŸÜŸàÿßŸÜ ÿßÿØŸÖ€åŸÜ Ÿàÿßÿ±ÿØ ÿ¥Ÿà€åÿØ!', 'error');
      return;
    }
    document.getElementById('deleteModal').style.display = 'flex';
    adminMenu.style.display = 'none';
  }
  
  function hideDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
  }

  // ÿ≠ÿ∞ŸÅ ŸáŸÖŸá ÿØÿßÿØŸá‚ÄåŸáÿß
  async function deleteAllData() {
    try {
      const res = await fetch(API_BASE + '/api/admin/delete-all', {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer Honor2025Admin!' }
      });
      
      if(!res.ok) throw new Error('ÿÆÿ∑ÿß ÿØÿ± ÿ≠ÿ∞ŸÅ ÿØÿßÿØŸá‚ÄåŸáÿß');
      
      showToast('ÿ™ŸÖÿßŸÖ ÿØÿßÿØŸá‚ÄåŸáÿß ÿ≠ÿ∞ŸÅ ÿ¥ÿØŸÜÿØ', 'success');
      hideDeleteModal();
      document.getElementById('dataTable').style.display = 'none';
    } catch(e) {
      showToast('ÿÆÿ∑ÿß ÿØÿ± ÿ≠ÿ∞ŸÅ: ' + e.message, 'error');
    }
  }

  // ÿßÿ™ÿµÿßŸÑ Enter key ÿ®Ÿá ŸÅÿ±ŸÖ
  document.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
      submitSale();
    }
  });

  // ŸÅŸÇÿ∑ ÿßÿπÿØÿßÿØ ÿØÿ± IMEI
  document.getElementById('imeiInput').addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 15);
  });

  // ŸÅŸÇÿ∑ ÿßÿπÿØÿßÿØ ÿØÿ± ÿ¥ŸÖÿßÿ±Ÿá ÿ™ŸÑŸÅŸÜ
  document.getElementById('phoneInput').addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 11);
  });

  // Escape key ÿ®ÿ±ÿß€å ÿ®ÿ≥ÿ™ŸÜ ŸÖŸàÿØÿßŸÑ
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      hideDeleteModal();
      adminMenu.style.display = 'none';
    }
  });
</script>

</body>
</html>